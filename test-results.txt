
> molam-id@1.0.0 test
> node src/test_runner.js

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  MOLAM-ID - Test Suite Complet (Briques 1-9)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Date: 2025-10-24T15:10:30.362Z
Tests to run: 10


ğŸ§ª Running Brique 1 - Table molam_users...
   File: test_brique1.js
ğŸ” Test Brique 1 â€“ Table molam_users

âœ… VÃ©rification de la table molam_users...
Table "public.molam_users"
       Column       |           Type           | Collation | Nullable |        Default        
--------------------+--------------------------+-----------+----------+-----------------------
 id                 | uuid                     |           | not null | gen_random_uuid()
 molam_id           | text                     |           | not null | 
 phone_e164         | text                     |           |          | 
 email              | text                     |           |          | 
 password_hash      | text                     |           |          | 
 ussd_pin_hash      | text                     |           |          | 
 role_profile       | text[]                   |           | not null | ARRAY['client'::text]
 status             | text                     |           | not null | 'pending'::text
 lang_pref          | text                     |           | not null | 'en'::text
 currency_pref      | text                     |           | not null | 'USD'::text
 kyc_status         | text                     |           | not null | 'none'::text
 kyc_reference      | text                     |           |          | 
 metadata           | jsonb                    |           |          | '{}'::jsonb
 created_at         | timestamp with time zone |           | not null | now()
 updated_at         | timestamp with time zone |           | not null | now()
 deleted_at         | timestamp with time zone |           |          | 
 user_type          | text                     |           |          | 'customer'::text
 is_kyc_verified    | boolean                  |           |          | false
 kyc_level          | text                     |           |          | 'P0'::text
 kyc_provider       | text                     |           |          | 
 kyc_provider_id    | text                     |           |          | 
 created_via        | text                     |           |          | 'app'::text
 twofa_enabled      | boolean                  |           |          | false
 twofa_methods      | text[]                   |           |          | ARRAY[]::text[]
 twofa_totp_secret  | text                     |           |          | 
 twofa_backup_codes | text[]                   |           |          | 
Indexes:
    "molam_users_pkey" PRIMARY KEY, btree (id)
    "idx_molam_users_phone" btree (phone_e164)
    "idx_molam_users_status" btree (status)
    "idx_users_kyc_level" btree (kyc_level)
    "idx_users_user_type" btree (user_type)
    "molam_users_email_key" UNIQUE CONSTRAINT, btree (email)
    "molam_users_molam_id_key" UNIQUE CONSTRAINT, btree (molam_id)
    "molam_users_phone_e164_key" UNIQUE CONSTRAINT, btree (phone_e164)
Referenced by:
    TABLE "molam_audit_logs" CONSTRAINT "molam_audit_logs_actor_fkey" FOREIGN KEY (actor) REFERENCES molam_users(id) ON DELETE SET NULL
    TABLE "molam_authz_decisions" CONSTRAINT "molam_authz_decisions_user_id_fkey" FOREIGN KEY (user_id) REFERENCES molam_users(id) ON DELETE CASCADE
    TABLE "molam_external_accounts" CONSTRAINT "molam_external_accounts_user_id_fkey" FOREIGN KEY (user_id) REFERENCES molam_users(id) ON DELETE CASCADE
    TABLE "molam_kyc_docs" CONSTRAINT "molam_kyc_docs_user_id_fkey" FOREIGN KEY (user_id) REFERENCES molam_users(id) ON DELETE CASCADE
    TABLE "molam_policies" CONSTRAINT "molam_policies_created_by_fkey" FOREIGN KEY (created_by) REFERENCES molam_users(id)
    TABLE "molam_roles" CONSTRAINT "molam_roles_granted_by_fkey" FOREIGN KEY (granted_by) REFERENCES molam_users(id)
    TABLE "molam_roles" CONSTRAINT "molam_roles_user_id_fkey" FOREIGN KEY (user_id) REFERENCES molam_users(id) ON DELETE CASCADE
    TABLE "molam_sessions" CONSTRAINT "molam_sessions_user_id_fkey" FOREIGN KEY (user_id) REFERENCES molam_users(id) ON DELETE CASCADE
    TABLE "molam_token_blacklist" CONSTRAINT "molam_token_blacklist_user_id_fkey" FOREIGN KEY (user_id) REFERENCES molam_users(id) ON DELETE CASCADE
    TABLE "molam_user_auth" CONSTRAINT "molam_user_auth_user_id_fkey" FOREIGN KEY (user_id) REFERENCES molam_users(id) ON DELETE CASCADE
    TABLE "molam_user_devices" CONSTRAINT "molam_user_devices_user_id_fkey" FOREIGN KEY (user_id) REFERENCES molam_users(id) ON DELETE CASCADE
    TABLE "molam_user_roles" CONSTRAINT "molam_user_roles_granted_by_fkey" FOREIGN KEY (granted_by) REFERENCES molam_users(id)
    TABLE "molam_user_roles" CONSTRAINT "molam_user_roles_user_id_fkey" FOREIGN KEY (user_id) REFERENCES molam_users(id) ON DELETE CASCADE
    TABLE "molam_verification_codes" CONSTRAINT "molam_verification_codes_user_id_fkey" FOREIGN KEY (user_id) REFERENCES molam_users(id) ON DELETE CASCADE

âœ… Insertion d'un utilisateur...

âœ… VÃ©rification de l'insertion...
molam_id      |           email           | status 
-------------------+---------------------------+--------
 MOLAM-SN-40793339 | test_b5_09271695@molam.sn | active
 MOLAM-SN-59180672 | admin_brique66@molam.sn   | active
 MOLAM-SN-38276369 | client_brique66@molam.sn  | active
 MOLAM-SN-01084865 | auto_test@molam.sn        | active
 MOLAM-SN-18361091 | test_17239970@molam.sn    | active
 MOLAM-SN-00000001 | brique1@molam.sn          | active
(6 rows)

âœ… Suppression de l'utilisateur...

ğŸ‰ Brique 1 validÃ©e !
âœ… Brique 1 - Table molam_users - PASSED

ğŸ§ª Running Brique 2 - Token refresh...
   File: test_brique2.js
ğŸ” Test Brique 2 â€“ Tables de support

âœ… VÃ©rification des tables...
List of relations
 Schema |           Name           | Type  | Owner 
--------+--------------------------+-------+-------
 public | molam_audit_logs         | table | molam
 public | molam_authz_cache        | table | molam
 public | molam_authz_decisions    | table | molam
 public | molam_external_accounts  | table | molam
 public | molam_failed_logins      | table | molam
 public | molam_kyc_docs           | table | molam
 public | molam_permissions        | table | molam
 public | molam_policies           | table | molam
 public | molam_rate_limits        | table | molam
 public | molam_refresh_tokens     | table | molam
 public | molam_revoked_tokens     | table | molam
 public | molam_role_permissions   | table | molam
 public | molam_roles              | table | molam
 public | molam_roles_catalog      | table | molam
 public | molam_sessions           | table | molam
 public | molam_token_blacklist    | table | molam
 public | molam_user_auth          | table | molam
 public | molam_user_devices       | table | molam
 public | molam_user_roles         | table | molam
 public | molam_users              | table | molam
 public | molam_verification_codes | table | molam
 public | molam_webhook_events     | table | molam
(22 rows)

âœ… Insertion d'un utilisateur de test...

âœ… CrÃ©ation d'un rÃ´le associÃ©...

âœ… CrÃ©ation d'une session...

âœ… CrÃ©ation d'un audit log...

âœ… VÃ©rification du rÃ´le, session et log...
count 
-------
     7
(1 row)
count 
-------
    12
(1 row)
count 
-------
   164
(1 row)

âœ… Suppression de l'utilisateur et cascade...

ğŸ‰ Brique 2 validÃ©e !
âœ… Brique 2 - Token refresh - PASSED

ğŸ§ª Running Brique 3 - Logout...
   File: test_brique3.js
ğŸ” VÃ©rification de l'accessibilitÃ© de l'API...
âœ… API accessible

ğŸ§ª  Signup
âŒ  Signup Ã©chouÃ© : 409 Conflict: {"error":"Email ou tÃ©lÃ©phone dÃ©jÃ  utilisÃ©"}

ğŸ§ª  Login
âŒ  Login Ã©chouÃ© : 401 Unauthorized: {"error":"Identifiants invalides"}

ğŸ§ª  Refresh token
âŒ  Refresh token Ã©chouÃ© : 400 Bad Request: {"error":"Token requis"}

ğŸ§ª  Logout
âŒ  Logout Ã©chouÃ© : 400 Bad Request: {"error":"Token requis"}

ğŸ§ª  VÃ©rification des logs d'audit
        action         |                                                                            meta                                                                             
-----------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------
 signup                | {"source": "test"}
 login                 | {"source": "api"}
 signup_complete       | {"has_password": true, "has_ussd_pin": false}
 signup_verify_success | {"channel": "sms", "verification_id": "2f7ae9e1-3a18-4cbb-a7ee-669fda04695d"}
 signup_init           | {"email": "other_17239970@molam.sn", "phone": null, "channel": "email", "user_type": "customer", "verification_id": "a526cf43-81bf-4e47-b768-18cf773c8b5f"}
(5 rows)


âœ…  VÃ©rification des logs d'audit OK

ğŸ§ª  VÃ©rification des hashs
âœ…  VÃ©rification des hashs OK

ğŸ§ª  DÃ©codage JWT
âŒ  DÃ©codage JWT Ã©chouÃ© : Pas de token disponible (les tests prÃ©cÃ©dents ont Ã©chouÃ©)

ğŸ‰  Tous les tests de la Brique 3 ont Ã©tÃ© exÃ©cutÃ©s !
âœ… Brique 3 - Logout - PASSED

ğŸ§ª Running Brique 4 - Onboarding foundations...
   File: test_brique4_foundations.js
ğŸ”§ Configuration DB: { host: 'localhost', port: '5432', user: 'molam', database: 'molam' }
ğŸ” Test Brique 4 - Fondations (SÃ©curitÃ© & Migrations)


ğŸ§ª  GÃ©nÃ©ration et hash OTP
   OTP gÃ©nÃ©rÃ©: 753015
âœ… Test de connexion rÃ©ussi: 2025-10-24T15:10:36.664Z
   Hash: $2b$10$KEPTIeDFC2/Qn...
âœ…  GÃ©nÃ©ration et hash OTP OK

ğŸ§ª  Hash mot de passe avec pepper
   Hash: $2b$10$lOrsHfrK/Ak5h...
âœ…  Hash mot de passe avec pepper OK

ğŸ§ª  Signature et vÃ©rification HMAC
   Signature: 237cced3524fa3c8c9ac...
   âœ“ Signatures invalides correctement rejetÃ©es
âœ…  Signature et vÃ©rification HMAC OK

ğŸ§ª  Signature et vÃ©rification HMAC
   Signature: 237cced3524fa3c8c9ac...
   âœ“ Signatures invalides correctement rejetÃ©es
âœ…  Signature et vÃ©rification HMAC OK

ğŸ§ª  Normalisation numÃ©ro de tÃ©lÃ©phone
   770001111 -> +221770001111
   0770001111 -> +221770001111
   +221770001111 -> +221770001111
   77 000 11 11 -> +221770001111
âœ…  Normalisation numÃ©ro de tÃ©lÃ©phone OK

ğŸ§ª  Validation format email
   2 valides, 3 invalides
âœ…  Validation format email OK

ğŸ§ª  Calcul expiration OTP
   Expire dans: 15.00 minutes
âœ…  Calcul expiration OTP OK

ğŸ§ª  GÃ©nÃ©ration device fingerprint
   Fingerprint: bae3f620fb173411e554...
âœ…  GÃ©nÃ©ration device fingerprint OK

ğŸ§ª  GÃ©nÃ©ration nonce pour replay protection
   Nonce 1: c1f8cb2157708ba3c33ed4f9da13f02e
   Nonce 2: 828437215aef4e9a1f95745a50b97b3d
âœ…  GÃ©nÃ©ration nonce pour replay protection OK

ğŸ§ª  VÃ©rification structure base de donnÃ©es
   Tables trouvÃ©es: 22
   - molam_audit_logs
   - molam_authz_cache
   - molam_authz_decisions
   - molam_external_accounts
   - molam_failed_logins
   - molam_kyc_docs
   - molam_permissions
   - molam_policies
   - molam_rate_limits
   - molam_refresh_tokens
   - molam_revoked_tokens
   - molam_role_permissions
   - molam_roles
   - molam_roles_catalog
   - molam_sessions
   - molam_token_blacklist
   - molam_user_auth
   - molam_user_devices
   - molam_user_roles
   - molam_users
   - molam_verification_codes
   - molam_webhook_events
âœ…  VÃ©rification structure base de donnÃ©es OK

ğŸ§ª  VÃ©rification colonnes onboarding molam_users
   Colonnes: is_kyc_verified, ussd_pin_hash, user_type, kyc_level, created_via
âœ…  VÃ©rification colonnes onboarding molam_users OK

ğŸ§ª  Insertion code de vÃ©rification
   Code ID: 1bfff120-e954-490f-97a4-53de7f70a73f
âœ…  Insertion code de vÃ©rification OK

ğŸ§ª  Rate limiting - tentatives autorisÃ©es
   Tentative 1: remaining = 2
   Tentative 2: remaining = 1
âœ…  Rate limiting - tentatives autorisÃ©es OK

ğŸ§ª  Rate limiting - blocage aprÃ¨s dÃ©passement
   âœ“ Correctement bloquÃ©: Rate limit exceeded. Retry after 3600 seconds.
âœ…  Rate limiting - blocage aprÃ¨s dÃ©passement OK

ğŸ§ª  Stockage Ã©vÃ©nement webhook
   Event ID: 34b22b3d-a654-40f3-8bc8-4bda131ed458
   Created: Fri Oct 24 2025 15:10:37 GMT+0000 (temps universel coordonnÃ©)
   âœ“ Protection contre les doublons active
âœ…  Stockage Ã©vÃ©nement webhook OK

ğŸ‰  Tous les tests de fondations Brique 4 rÃ©ussis !
âœ… Brique 4 - Onboarding foundations - PASSED

ğŸ§ª Running Brique 4 - Onboarding flow...
   File: test_brique4_onboarding.js
ğŸ” Test Brique 4 - Onboarding Complet

ğŸ“± TÃ©lÃ©phone de test: 7718637496
ğŸ“§ Email de test: test_18637496@molam.sn


ğŸ§ª  Signup Init - SMS
   Verification ID: c9fa6916-f876-40c8-86f6-e0802bcf4afa
   Canal: sms
   Expire dans: 900s
   ğŸ”‘ OTP (dev): 365949
âœ…  Signup Init - SMS OK

ğŸ§ª  Signup Init - Email (second test)
   Verification ID: 9c2f26e0-e104-4649-95d6-6dc9e0ea604f
   Canal: email
âœ…  Signup Init - Email (second test) OK

ğŸ§ª  Signup Verify - Code incorrect
   âœ“ Code incorrect rejetÃ©
âœ…  Signup Verify - Code incorrect OK

ğŸ§ª  Signup Verify - Code correct
   Message: VÃ©rification rÃ©ussie
   MOLAM ID: MOLAM-SN-95209686
   Prochaine Ã©tape: complete_profile
âœ…  Signup Verify - Code correct OK

ğŸ§ª  Signup Complete - Sans mot de passe
   âœ“ Mot de passe requis
âœ…  Signup Complete - Sans mot de passe OK

ğŸ§ª  Signup Complete - Mot de passe faible
   âœ“ Mot de passe faible rejetÃ©
âœ…  Signup Complete - Mot de passe faible OK

ğŸ§ª  Signup Complete - Mot de passe valide
   Message: Inscription terminÃ©e avec succÃ¨s
   MOLAM ID: MOLAM-SN-95209686
   KYC Level: P0
âœ…  Signup Complete - Mot de passe valide OK

ğŸ§ª  Signup Init - Doublon dÃ©tectÃ©
   âœ“ Doublon correctement rejetÃ©
âœ…  Signup Init - Doublon dÃ©tectÃ© OK

ğŸ§ª  VÃ©rification BDD - Utilisateur crÃ©Ã©
     molam_id      |   phone_e164   | status | user_type | kyc_level 
-------------------+----------------+--------+-----------+-----------
 MOLAM-SN-95209686 | +2217718637496 | active | customer  | P0
(1 row)


âœ…  VÃ©rification BDD - Utilisateur crÃ©Ã© OK

ğŸ§ª  VÃ©rification BDD - RÃ´le assignÃ©
 module |  role  
--------+--------
 id     | client
(1 row)


âœ…  VÃ©rification BDD - RÃ´le assignÃ© OK

ğŸ§ª  VÃ©rification BDD - Session active
 count 
-------
     1
(1 row)


âœ…  VÃ©rification BDD - Session active OK

ğŸ§ª  VÃ©rification BDD - Logs d'audit
        action         
-----------------------
 signup_init
 signup_verify_success
 signup_complete
(3 rows)


   âœ“ Actions principales prÃ©sentes
âœ…  VÃ©rification BDD - Logs d'audit OK

ğŸ§ª  VÃ©rification BDD - Mot de passe hashÃ©
   âœ“ Mot de passe correctement hashÃ©
âœ…  VÃ©rification BDD - Mot de passe hashÃ© OK

ğŸ§ª  Login avec le nouveau compte
   Access token reÃ§u: eyJhbGciOiJIUzI1NiIs...
âœ…  Login avec le nouveau compte OK

ğŸ‰  Tous les tests d'onboarding Brique 4 rÃ©ussis !

ğŸ“‹  RÃ©sumÃ©:
   MOLAM ID crÃ©Ã©: MOLAM-SN-95209686
   TÃ©lÃ©phone: +2217718637496
   Email: test_18637496@molam.sn
   Statut: active
   KYC Level: P0
âœ… Brique 4 - Onboarding flow - PASSED

ğŸ§ª Running Brique 5 - Session Management...
   File: test_brique5.js
ğŸ” Test Brique 5 â€“ Session Management

âœ… Step 1: CrÃ©ation utilisateur test...
âŒ Erreur Brique 5: Signup init failed: {"error":"TÃ©lÃ©phone ou email requis"}
âŒ Brique 5 - Session Management - FAILED (exit code: 1)

ğŸ§ª Running Brique 6 - RBAC & AuthZ...
   File: test_brique6_authz.js
ğŸ” Test Brique 6 - RBAC & AuthZ Service

========================================

============================================================
PARTIE 1: CRÃ‰ATION DES COMPTES DE TEST
============================================================

ğŸ§ª  1.1 - CrÃ©er un utilisateur admin
âŒ  1.1 - CrÃ©er un utilisateur admin Ã©chouÃ© : 409 Conflict: {"error":"Email ou tÃ©lÃ©phone dÃ©jÃ  utilisÃ©"}

ğŸ§ª  1.2 - CrÃ©er un utilisateur client
âŒ  1.2 - CrÃ©er un utilisateur client Ã©chouÃ© : 409 Conflict: {"error":"Email ou tÃ©lÃ©phone dÃ©jÃ  utilisÃ©"}

============================================================
PARTIE 1.5: BOOTSTRAP ADMIN (Attribution id_admin via SQL)
============================================================

ğŸ§ª  1.5 - Attribuer id_admin Ã  l'admin via SQL
âŒ  1.5 - Attribuer id_admin Ã  l'admin via SQL Ã©chouÃ© : Command failed: docker compose exec -T db psql -U molam -d molam -c "INSERT INTO molam_user_roles (user_id, role_name, module, trusted_level, granted_by, granted_at) VALUES ('', 'id_admin', 'id', 100, NULL, NOW()) ON CONFLICT DO NOTHING;"
ERROR:  invalid input syntax for type uuid: ""
LINE 1: ...e, trusted_level, granted_by, granted_at) VALUES ('', 'id_ad...
                                                             ^


============================================================
PARTIE 2: ATTRIBUTION DES RÃ”LES
============================================================

ğŸ§ª  2.1 - Attribuer le rÃ´le id_admin Ã  l'admin
âŒ  2.1 - Attribuer le rÃ´le id_admin Ã  l'admin Ã©chouÃ© : Unexpected token '<', "<!DOCTYPE "... is not valid JSON

ğŸ§ª  2.2 - Attribuer le rÃ´le pay_client au client
âŒ  2.2 - Attribuer le rÃ´le pay_client au client Ã©chouÃ© : Unexpected token '<', "<!DOCTYPE "... is not valid JSON

============================================================
PARTIE 3: CONSULTATION DES RÃ”LES ET PERMISSIONS
============================================================

ğŸ§ª  3.1 - Lister les rÃ´les de l'admin
âŒ  3.1 - Lister les rÃ´les de l'admin Ã©chouÃ© : Unexpected token '<', "<!DOCTYPE "... is not valid JSON

ğŸ§ª  3.2 - Lister les permissions de l'admin
âŒ  3.2 - Lister les permissions de l'admin Ã©chouÃ© : Unexpected token '<', "<!DOCTYPE "... is not valid JSON

ğŸ§ª  3.3 - Lister les rÃ´les du client
âŒ  3.3 - Lister les rÃ´les du client Ã©chouÃ© : Unexpected token '<', "<!DOCTYPE "... is not valid JSON

ğŸ§ª  3.4 - Lister les permissions du client
âŒ  3.4 - Lister les permissions du client Ã©chouÃ© : Unexpected token '<', "<!DOCTYPE "... is not valid JSON

============================================================
PARTIE 4: DÃ‰CISIONS D'AUTORISATION
============================================================

ğŸ§ª  4.1 - Admin accÃ¨de Ã  une route admin
âŒ  4.1 - Admin accÃ¨de Ã  une route admin Ã©chouÃ© : 400 Bad Request: {"error":"bad_request","message":"user_id is required"}

ğŸ§ª  4.2 - Client accÃ¨de Ã  une route pay_transfer avec KYC P2
âŒ  4.2 - Client accÃ¨de Ã  une route pay_transfer avec KYC P2 Ã©chouÃ© : 400 Bad Request: {"error":"bad_request","message":"user_id is required"}

ğŸ§ª  4.3 - Client accÃ¨de Ã  pay_transfer avec KYC P0 (doit Ãªtre refusÃ©)
âŒ  4.3 - Client accÃ¨de Ã  pay_transfer avec KYC P0 (doit Ãªtre refusÃ©) Ã©chouÃ© : 400 Bad Request: {"error":"bad_request","message":"user_id is required"}

ğŸ§ª  4.4 - Client accÃ¨de Ã  pay_transfer avec SIRA score bas
âŒ  4.4 - Client accÃ¨de Ã  pay_transfer avec SIRA score bas Ã©chouÃ© : 400 Bad Request: {"error":"bad_request","message":"user_id is required"}

ğŸ§ª  4.5 - Client accÃ¨de Ã  une route d'un autre module
âŒ  4.5 - Client accÃ¨de Ã  une route d'un autre module Ã©chouÃ© : 400 Bad Request: {"error":"bad_request","message":"user_id is required"}

============================================================
PARTIE 5: TEST DU CACHE
============================================================

ğŸ§ª  5.1 - PremiÃ¨re dÃ©cision (non cached)
âŒ  5.1 - PremiÃ¨re dÃ©cision (non cached) Ã©chouÃ© : 400 Bad Request: {"error":"bad_request","message":"user_id is required"}

ğŸ§ª  5.2 - DeuxiÃ¨me dÃ©cision identique (doit Ãªtre cached)
âŒ  5.2 - DeuxiÃ¨me dÃ©cision identique (doit Ãªtre cached) Ã©chouÃ© : 400 Bad Request: {"error":"bad_request","message":"user_id is required"}

============================================================
PARTIE 6: RÃ‰VOCATION DE RÃ”LE
============================================================

ğŸ§ª  6.1 - RÃ©voquer le rÃ´le pay_client du client
âŒ  6.1 - RÃ©voquer le rÃ´le pay_client du client Ã©chouÃ© : Unexpected token '<', "<!DOCTYPE "... is not valid JSON

ğŸ§ª  6.2 - VÃ©rifier que le client n'a plus le rÃ´le
âŒ  6.2 - VÃ©rifier que le client n'a plus le rÃ´le Ã©chouÃ© : Unexpected token '<', "<!DOCTYPE "... is not valid JSON

============================================================
ğŸ‰  TESTS DE LA BRIQUE 6 TERMINÃ‰S !
============================================================

ğŸ“‹  RÃ©sumÃ©:
   Admin MOLAM ID: 
   Client MOLAM ID: 

âœ…  FonctionnalitÃ©s testÃ©es:
   â€¢ Attribution et rÃ©vocation de rÃ´les
   â€¢ Consultation des rÃ´les et permissions
   â€¢ DÃ©cisions d'autorisation (allow/deny)
   â€¢ Policies ABAC (KYC level, SIRA score)
   â€¢ Isolation par module
   â€¢ Cache des dÃ©cisions
   â€¢ Audit trail
âœ… Brique 6 - RBAC & AuthZ - PASSED

ğŸ§ª Running Brique 7 - Audit Immuable...
   File: test_brique7.js
ğŸ” Test Brique 7 â€“ Audit Logs Immuables

âœ… Step 1: Health check verifier API...
   Status: ok
âœ… Step 2: Insertion Ã©vÃ©nement audit test...
psql: erreur : la connexion au serveur sur ï¿½ localhost ï¿½ (::1), port 5432 a ï¿½chouï¿½ : FATAL:  database "molam_audit" does not exist
   âš  Direct DB insert failed (may need docker): Command failed: psql "postgres://molam:molam_pass@localhost:5432/molam_audit" -c "       INSERT INTO audit_events (id, event_time, event_type, module, payload, record_hash, signature, signer_key_id)       VALUES (         '1efa7ce9-f03c-49c3-b893-ca94ab345770',         '2025-10-24T15:10:41.107Z',         'test.integration',         'test',         '{"test": "brique7", "timestamp": "2025-10-24T15:10:41.107Z"}',         'dGVzdC1oYXNoLTE3NjEzMTg2NDExMDg=',         'dGVzdC1zaWctMTc2MTMxODY0MTEwOA==',         'local'       );     "
psql: erreur : la connexion au serveur sur ï¿½ localhost ï¿½ (::1), port 5432 a ï¿½chouï¿½ : FATAL:  database "molam_audit" does not exist

   Trying via docker...
Error response from daemon: container 9f8f06e5aa6e012629f65886ca243ce3b65e90b00df2716f7ff46c433e86fefb is not running
âŒ Erreur Brique 7: Command failed: docker exec molam-postgres psql -U molam -d molam_audit -c "       INSERT INTO audit_events (id, event_time, event_type, module, payload, record_hash, signature, signer_key_id)       VALUES (         '1efa7ce9-f03c-49c3-b893-ca94ab345770',         '2025-10-24T15:10:41.107Z',         'test.integration',         'test',         '{"test": "brique7", "timestamp": "2025-10-24T15:10:41.107Z"}',         'dGVzdC1oYXNoLTE3NjEzMTg2NDExMDg=',         'dGVzdC1zaWctMTc2MTMxODY0MTEwOA==',         'local'       );     "
Error response from daemon: container 9f8f06e5aa6e012629f65886ca243ce3b65e90b00df2716f7ff46c433e86fefb is not running

âŒ Brique 7 - Audit Immuable - FAILED (exit code: 1)

ğŸ§ª Running Brique 8 - KYC/AML...
   File: test_brique8.js
ğŸ” Test Brique 8 â€“ KYC/AML Pipeline

âœ… Step 1: Health check KYC API...
   Status: ok
   Service: kyc-api
âœ… Step 2: CrÃ©ation images de test...
âŒ Erreur Brique 8: ENOENT: no such file or directory, mkdtemp '/tmp/kyc-test-XXXXXX'
âŒ Brique 8 - KYC/AML - FAILED (exit code: 1)

ğŸ§ª Running Brique 9 - Extended AuthZ...
   File: test_brique9.js

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                           â•‘
â•‘       ğŸ§ª BRIQUE 9 - AuthZ ext_authz TEST SUITE          â•‘
â•‘                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ TEST 1: Verify Brique 9 Schema
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âŒ ASSERTION FAILED: All 6 Brique 9 tables exist

âŒ TEST SUITE FAILED
Error: All 6 Brique 9 tables exist
Error: All 6 Brique 9 tables exist
    at assert (file:///C:/Users/lomao/Desktop/Molam/Molam-id/src/test_brique9.js:52:11)
    at test1_createSchema (file:///C:/Users/lomao/Desktop/Molam/Molam-id/src/test_brique9.js:86:3)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async runAllTests (file:///C:/Users/lomao/Desktop/Molam/Molam-id/src/test_brique9.js:519:5)
âŒ Brique 9 - Extended AuthZ - FAILED (exit code: 1)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  RÃ‰SUMÃ‰ DES TESTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DurÃ©e totale: 12.78s

âœ… PASSED  : 6
   - Brique 1 - Table molam_users
   - Brique 2 - Token refresh
   - Brique 3 - Logout
   - Brique 4 - Onboarding foundations
   - Brique 4 - Onboarding flow
   - Brique 6 - RBAC & AuthZ

âŒ FAILED  : 4
   - Brique 5 - Session Management
   - Brique 7 - Audit Immuable
   - Brique 8 - KYC/AML
   - Brique 9 - Extended AuthZ

âš ï¸  SKIPPED : 0

Taux de rÃ©ussite: 60.0% (6/10)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PAR CATÃ‰GORIE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

AUTH:
  âœ… 3 | âŒ 1 | âš ï¸  0 | 75.0%
ONBOARDING:
  âœ… 2 | âŒ 0 | âš ï¸  0 | 100.0%
AUTHZ:
  âœ… 1 | âŒ 1 | âš ï¸  0 | 50.0%
AUDIT:
  âœ… 0 | âŒ 1 | âš ï¸  0 | 0.0%
KYC:
  âœ… 0 | âŒ 1 | âš ï¸  0 | 0.0%

ğŸ“Š Rapport sauvegardÃ©: C:\Users\lomao\Desktop\Molam\Molam-id\test-report.json

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

