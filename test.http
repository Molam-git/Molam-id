### Molam-ID API Tests
### Utiliser avec l'extension VS Code "REST Client"

@baseUrl = http://localhost:3000
@email = test@molam.sn
@password = SecurePass123!

### ============================================================================
### HEALTH CHECKS
### ============================================================================

### 1. Service Info
GET {{baseUrl}}/ HTTP/1.1
Accept: application/json

### 2. Health Check
GET {{baseUrl}}/api/health HTTP/1.1

### 3. Kubernetes Health
GET {{baseUrl}}/healthz HTTP/1.1

### ============================================================================
### SIGNUP FLOW (Onboarding)
### ============================================================================

### 4. Signup Init
# @name signupInit
POST {{baseUrl}}/api/id/signup/init HTTP/1.1
Content-Type: application/json

{
  "channel": "email",
  "identifier": "{{email}}",
  "password": "{{password}}",
  "full_name": "Test User Molam"
}

### Récupérer signup_id
@signupId = {{signupInit.response.body.signup_id}}

### 5. Signup Verify (remplacer CODE par le code OTP des logs)
# @name signupVerify
POST {{baseUrl}}/api/id/signup/verify HTTP/1.1
Content-Type: application/json

{
  "signup_id": "{{signupId}}",
  "code": "123456"
}

### 6. Signup Complete
# @name signupComplete
POST {{baseUrl}}/api/id/signup/complete HTTP/1.1
Content-Type: application/json

{
  "signup_id": "{{signupId}}"
}

### Récupérer les tokens
@accessToken = {{signupComplete.response.body.access_token}}
@refreshToken = {{signupComplete.response.body.refresh_token}}
@userId = {{signupComplete.response.body.user_id}}
@sessionId = {{signupComplete.response.body.session_id}}

### ============================================================================
### LOGIN
### ============================================================================

### 7. Login V2
# @name login
POST {{baseUrl}}/api/id/login HTTP/1.1
Content-Type: application/json

{
  "identifier": "{{email}}",
  "password": "{{password}}",
  "identifier_type": "email"
}

### Mettre à jour le token depuis le login
# @accessToken = {{login.response.body.access_token}}

### ============================================================================
### MFA/2FA (Brique 11)
### ============================================================================

### 8. MFA Setup (obtenir QR code)
# @name mfaSetup
POST {{baseUrl}}/api/id/mfa/setup HTTP/1.1
Authorization: Bearer {{accessToken}}

### Récupérer le secret
@mfaSecret = {{mfaSetup.response.body.secret}}

### 9. MFA Enable (remplacer par code TOTP de Google Authenticator)
POST {{baseUrl}}/api/id/mfa/enable HTTP/1.1
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "code": "123456"
}

### 10. MFA Verify
POST {{baseUrl}}/api/id/mfa/verify HTTP/1.1
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "code": "654321"
}

### 11. MFA Status
GET {{baseUrl}}/api/id/mfa/status HTTP/1.1
Authorization: Bearer {{accessToken}}

### 12. MFA Disable
POST {{baseUrl}}/api/id/mfa/disable HTTP/1.1
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "code": "123456"
}

### ============================================================================
### PASSWORD MANAGEMENT (Brique 6)
### ============================================================================

### 13. Password Forgot (demander reset)
POST {{baseUrl}}/api/id/password/forgot HTTP/1.1
Content-Type: application/json

{
  "email": "{{email}}"
}

### 14. Password Reset (remplacer TOKEN par le token des logs)
POST {{baseUrl}}/api/id/password/reset HTTP/1.1
Content-Type: application/json

{
  "token": "YOUR_RESET_TOKEN_FROM_LOGS",
  "new_password": "NewSecurePass456!"
}

### 15. Password Change (authentifié)
POST {{baseUrl}}/api/id/password/change HTTP/1.1
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "old_password": "{{password}}",
  "new_password": "AnotherSecurePass789!"
}

### ============================================================================
### DEVICE FINGERPRINTING (Brique 10)
### ============================================================================

### 16. Register Device
# @name registerDevice
POST {{baseUrl}}/api/id/devices/register HTTP/1.1
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "device_info": {
    "device_type": "desktop",
    "os": "Windows",
    "os_version": "11",
    "browser": "Chrome",
    "browser_version": "120",
    "screen_resolution": "1920x1080",
    "timezone": "Africa/Dakar",
    "language": "fr-FR",
    "country": "SN",
    "city": "Dakar",
    "metadata": {
      "canvas_fingerprint": "abc123def456",
      "webgl_fingerprint": "ghi789jkl012"
    }
  }
}

### Récupérer device_id
@deviceId = {{registerDevice.response.body.device_id}}

### 17. List My Devices
GET {{baseUrl}}/api/id/devices HTTP/1.1
Authorization: Bearer {{accessToken}}

### 18. Get Device Sessions
GET {{baseUrl}}/api/id/devices/{{deviceId}}/sessions HTTP/1.1
Authorization: Bearer {{accessToken}}

### 19. Update Device Trust
POST {{baseUrl}}/api/id/devices/{{deviceId}}/trust HTTP/1.1
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "trust_level": "trusted"
}

### 20. Remove Device
DELETE {{baseUrl}}/api/id/devices/{{deviceId}} HTTP/1.1
Authorization: Bearer {{accessToken}}

### ============================================================================
### SESSION MANAGEMENT
### ============================================================================

### 21. List My Sessions
GET {{baseUrl}}/api/id/sessions HTTP/1.1
Authorization: Bearer {{accessToken}}

### 22. Revoke One Session
POST {{baseUrl}}/api/id/sessions/{{sessionId}}/revoke HTTP/1.1
Authorization: Bearer {{accessToken}}

### 23. Revoke All Sessions
POST {{baseUrl}}/api/id/sessions/revoke-all HTTP/1.1
Authorization: Bearer {{accessToken}}

### 24. Refresh Token
POST {{baseUrl}}/api/id/refresh HTTP/1.1
Content-Type: application/json

{
  "refresh_token": "{{refreshToken}}"
}

### 25. Logout
POST {{baseUrl}}/api/id/logout HTTP/1.1
Authorization: Bearer {{accessToken}}

### ============================================================================
### BLACKLIST (Brique 13) - Admin Only
### ============================================================================

### 26. Add to Blacklist (Admin)
POST {{baseUrl}}/api/id/blacklist/add HTTP/1.1
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "type": "ip",
  "value": "192.168.1.100",
  "reason": "Suspicious activity detected",
  "severity": "high",
  "expires_at": null
}

### 27. List Blacklist (Admin)
GET {{baseUrl}}/api/id/blacklist HTTP/1.1
Authorization: Bearer {{accessToken}}

### 28. Remove from Blacklist (Admin)
DELETE {{baseUrl}}/api/id/blacklist/BLACKLIST_ENTRY_ID HTTP/1.1
Authorization: Bearer {{accessToken}}

### ============================================================================
### RBAC & PERMISSIONS (Briques 20-23)
### ============================================================================

### 29. Get User Roles
GET {{baseUrl}}/v1/authz/users/{{userId}}/roles HTTP/1.1
Authorization: Bearer {{accessToken}}

### 30. Get User Permissions
GET {{baseUrl}}/v1/authz/users/{{userId}}/permissions HTTP/1.1
Authorization: Bearer {{accessToken}}

### 31. Assign Role (Admin)
POST {{baseUrl}}/v1/authz/users/{{userId}}/roles HTTP/1.1
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "role_name": "id_admin",
  "module": "id",
  "trusted_level": 100
}

### 32. Revoke Role (Admin)
DELETE {{baseUrl}}/v1/authz/users/{{userId}}/roles/id_admin?module=id HTTP/1.1
Authorization: Bearer {{accessToken}}

### 33. Authorization Decision
POST {{baseUrl}}/v1/authz/decide HTTP/1.1
Content-Type: application/json

{
  "user_id": "{{userId}}",
  "path": "/api/id/users",
  "method": "GET",
  "module": "id",
  "context": {}
}

### ============================================================================
### TEST AUTO-BLACKLIST (5 tentatives échouées)
### ============================================================================

### Tentative 1 (mauvais password)
POST {{baseUrl}}/api/id/login HTTP/1.1
Content-Type: application/json

{
  "identifier": "{{email}}",
  "password": "WRONG_PASSWORD",
  "identifier_type": "email"
}

### Tentative 2
POST {{baseUrl}}/api/id/login HTTP/1.1
Content-Type: application/json

{
  "identifier": "{{email}}",
  "password": "WRONG_PASSWORD",
  "identifier_type": "email"
}

### Tentative 3
POST {{baseUrl}}/api/id/login HTTP/1.1
Content-Type: application/json

{
  "identifier": "{{email}}",
  "password": "WRONG_PASSWORD",
  "identifier_type": "email"
}

### Tentative 4
POST {{baseUrl}}/api/id/login HTTP/1.1
Content-Type: application/json

{
  "identifier": "{{email}}",
  "password": "WRONG_PASSWORD",
  "identifier_type": "email"
}

### Tentative 5 (après celle-ci, blacklist automatique)
POST {{baseUrl}}/api/id/login HTTP/1.1
Content-Type: application/json

{
  "identifier": "{{email}}",
  "password": "WRONG_PASSWORD",
  "identifier_type": "email"
}

### Tentative 6 (devrait être bloqué)
POST {{baseUrl}}/api/id/login HTTP/1.1
Content-Type: application/json

{
  "identifier": "{{email}}",
  "password": "{{password}}",
  "identifier_type": "email"
}
