# üé§ Brique 8 ‚Äî Voice Auth (Authentification Vocale)

> Syst√®me d'authentification vocale forte, inclusive et accessible pour tous les profils Molam (clients, marchands, agents, employ√©s)

[![TypeScript](https://img.shields.io/badge/TypeScript-5.3-blue)](https://www.typescriptlang.org/)
[![Node.js](https://img.shields.io/badge/Node.js-18+-green)](https://nodejs.org/)
[![License](https://img.shields.io/badge/License-Proprietary-red)](LICENSE)

---

## üìã Table des mati√®res

- [Vue d'ensemble](#vue-densemble)
- [Fonctionnalit√©s](#fonctionnalit√©s)
- [Architecture](#architecture)
- [Installation](#installation)
- [Configuration](#configuration)
- [API Endpoints](#api-endpoints)
- [Int√©gration Client](#int√©gration-client)
- [S√©curit√©](#s√©curit√©)
- [Tests](#tests)
- [D√©ploiement](#d√©ploiement)
- [Observabilit√©](#observabilit√©)

---

## üéØ Vue d'ensemble

La **Brique 8 - Voice Auth** fournit une authentification vocale:

### Objectif
Fournir une authentification vocale **forte** et **inclusive** (accessibilit√©, faible litt√©ratie) pour tous les profils, sans stocker d'audio brut comme secret.

### Principe de s√©curit√©
- ‚úÖ **Embeddings uniquement**: On stocke un gabarit vocal d√©riv√© (embedding num√©rique) salt√© et hach√©
- ‚ùå **Zero audio storage**: L'audio brut est √©ph√©m√®re (chiffr√© S3, <24h) et purg√© apr√®s extraction
- üîê **Privacy-first**: Envelope encryption (AES-256-GCM) + KMS
- üéØ **Anti-spoofing**: Score ML int√©gr√© pour d√©tecter les attaques

### Cas d'usage
- **Step-up**: Op√©rations sensibles (reset PIN USSD, √©l√©vation plafond, virement marchand)
- **Login fort**: Alternative/fallback √† la biom√©trie locale (Brique 7) quand indisponible
- **Accessibilit√©**: Canal IVR/USSD vocal pour personnes non lectrices
- **Multi-langue**: Phrases locales (Wolof, Fran√ßais, Anglais, Arabe, etc.)

---

## ‚ú® Fonctionnalit√©s

### üéôÔ∏è Enr√¥lement vocal
- G√©n√©ration de phrase al√©atoire par locale
- Capture audio (5-15 secondes)
- Extraction embedding via ML service
- Quality & spoofing checks
- Stockage chiffr√© avec sel unique

### ‚úÖ V√©rification vocale
- Challenge-response avec phrase dynamique
- Comparaison cosine similarity
- Seuils adaptatifs par utilisateur
- Step-up TTL (5 minutes par d√©faut)

### üåç Multi-plateforme
- **Web**: MediaRecorder API (WebM/WAV)
- **iOS**: AVAudioRecorder (16kHz mono WAV)
- **Android**: MediaRecorder (3GP/AMR-NB)
- **IVR**: Webhooks Twilio, Infobip, Africa's Talking

### üîí S√©curit√© avanc√©e
- JWT RS256 authentication
- mTLS √† la gateway
- Rate limiting (Redis)
- Anti-replay (nonce)
- Audit immuable (WORM S3)
- SIRA integration (risk scoring)

### üéõÔ∏è Pr√©f√©rences utilisateur
- Activation/d√©sactivation
- Seuils de similarit√© personnalisables
- Seuils anti-spoofing
- Cooldown apr√®s √©checs

---

## üèóÔ∏è Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Client App ‚îÇ  (Web/iOS/Android/IVR)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ HTTPS + JWT
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Voice Auth API (Port 8081)         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ Routes:                     ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  - /v1/voice/enroll         ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  - /v1/voice/assert         ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  - /v1/voice/prefs          ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  - /v1/ivr/webhook          ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò
   ‚îÇ         ‚îÇ         ‚îÇ          ‚îÇ
   ‚ñº         ‚ñº         ‚ñº          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PG   ‚îÇ ‚îÇRedis‚îÇ ‚îÇS3 Temp ‚îÇ ‚îÇVoice ML‚îÇ
‚îÇ DB   ‚îÇ ‚îÇ     ‚îÇ ‚îÇ(Audio) ‚îÇ ‚îÇ(gRPC)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   ‚îÇ                          ‚îÇ
   ‚îÇ    Embeddings (encrypted)‚îÇ
   ‚îÇ    Attempts (audit)      ‚îÇ
   ‚îÇ                          ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  SIRA   ‚îÇ  (Risk Engine)
        ‚îÇ Signals ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Composants

| Composant | Description | Techno |
|-----------|-------------|--------|
| **Voice Auth API** | Service REST principal | Express + TypeScript |
| **Voice ML** | Extraction embeddings + anti-spoof | Python (ECAPA-TDNN) |
| **PostgreSQL** | Credentials, prefs, attempts | pg |
| **Redis** | Rate limiting, nonce | redis |
| **S3** | Audio √©ph√©m√®re (<24h) | AWS S3 + lifecycle |
| **SIRA** | Risk scoring adaptatif | Redis Streams |

---

## üöÄ Installation

### Pr√©requis

- Node.js 18+
- PostgreSQL 14+
- Redis 6+
- AWS S3 (ou MinIO)
- Voice ML service (microservice s√©par√©)

### Setup

```bash
cd brique-08-voice-auth

# Install dependencies
npm install

# Copy environment file
cp .env.example .env

# Edit .env with your config
nano .env

# Run database migrations
psql -U postgres -d molam_id -f sql/002_voice_auth.sql

# Build TypeScript
npm run build

# Start service
npm start
```

### Development

```bash
# Watch mode (auto-reload)
npm run dev

# Run tests
npm test

# Lint
npm run lint
```

---

## ‚öôÔ∏è Configuration

Voir [.env.example](.env.example) pour la liste compl√®te.

### Variables essentielles

```env
# Server
PORT=8081
NODE_ENV=production

# JWT
JWT_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----"

# Encryption (32-byte hex key)
DATA_ENC_KEY=your-32-byte-hex-key

# Database
DATABASE_URL=postgresql://molam:pass@localhost:5432/molam_id

# S3 (ephemeral audio, <24h retention)
S3_TEMP_BUCKET=molam-voice-temp
AWS_REGION=eu-west-1

# Voice ML service
VOICE_ML_URL=http://voice-ml:9000

# IVR
IVR_WEBHOOK_SECRET=your-webhook-secret

# SIRA
SIRA_ENABLED=true
```

---

## üì° API Endpoints

### Authentication

Tous les endpoints `/v1/voice/*` requi√®rent un **JWT Bearer token**.

```
Authorization: Bearer eyJhbGciOiJSUzI1NiIs...
```

### Enr√¥lement vocal

#### 1Ô∏è‚É£ Begin Enrollment

```http
POST /v1/voice/enroll/begin
Content-Type: application/json

{
  "locale": "fr_SN"  // fr_SN, wo_SN, en_GH, ar_MA
}
```

**Response:**
```json
{
  "phrase": "Je confirme √™tre le propri√©taire de ce compte Molam",
  "reqId": "uuid",
  "locale": "fr_SN"
}
```

#### 2Ô∏è‚É£ Upload Audio

```http
POST /v1/voice/upload
Content-Type: application/json

{
  "reqId": "uuid",
  "base64": "UklGRiQAAABXQVZF...",
  "mime": "audio/wav"
}
```

**Response:**
```json
{
  "status": "ok",
  "key": "voice/user-123/req-456.wav"
}
```

#### 3Ô∏è‚É£ Finish Enrollment

```http
POST /v1/voice/enroll/finish
Content-Type: application/json

{
  "reqId": "uuid",
  "key": "voice/user-123/req-456.wav",
  "locale": "fr_SN",
  "channel": "mobile_app",
  "phrase": "Je confirme..."
}
```

**Response:**
```json
{
  "status": "ok",
  "enrolled": true,
  "replaced": false
}
```

### V√©rification vocale

#### 1Ô∏è‚É£ Begin Verification

```http
POST /v1/voice/assert/begin
Content-Type: application/json

{
  "locale": "fr_SN"
}
```

**Response:**
```json
{
  "reqId": "uuid",
  "phrase": "Molam s√©curise mon argent aujourd'hui"
}
```

#### 2Ô∏è‚É£ Upload Audio (same as enrollment)

#### 3Ô∏è‚É£ Finish Verification

```http
POST /v1/voice/assert/finish
Content-Type: application/json

{
  "reqId": "uuid",
  "key": "voice/user-123/req-789.wav",
  "channel": "mobile_app"
}
```

**Response (success):**
```json
{
  "status": "ok",
  "similarity": 0.8542,
  "spoofing": 0.12,
  "ttl_sec": 300
}
```

**Response (failure):**
```json
{
  "error": "voice_not_match",
  "similarity": 0.6234,
  "spoofing": 0.08
}
```

### Pr√©f√©rences

#### Get Preferences

```http
GET /v1/voice/prefs
```

**Response:**
```json
{
  "user_id": "uuid",
  "voice_enabled": true,
  "require_voice_for_sensitive": false,
  "similarity_threshold": 0.78,
  "spoofing_threshold": 0.35,
  "max_failures": 5,
  "cooldown_sec": 900
}
```

#### Update Preferences

```http
PATCH /v1/voice/prefs
Content-Type: application/json

{
  "voice_enabled": true,
  "similarity_threshold": 0.80
}
```

### R√©vocation

```http
DELETE /v1/voice/credentials
```

**Response:**
```json
{
  "status": "ok",
  "revoked": true
}
```

### IVR Webhook

```http
POST /v1/ivr/webhook
X-IVR-Signature: sha256=<hmac>

{
  "userId": "uuid",
  "reqId": "uuid",
  "audioBase64": "...",
  "phone": "+221XXXXXXXX"
}
```

---

## üíª Int√©gration Client

### Web (TypeScript)

```typescript
import { VoiceAuth } from './voiceAuth';

const voice = new VoiceAuth('https://api.molam.com', jwtToken);

// Enrollment
try {
  await voice.enroll('fr_SN');
  console.log('‚úÖ Voice enrolled!');
} catch (error) {
  console.error('‚ùå Enrollment failed:', error);
}

// Verification
try {
  const { similarity, spoofing } = await voice.verify('fr_SN');
  console.log(`‚úÖ Verified! Similarity: ${similarity}`);
} catch (error) {
  console.error('‚ùå Verification failed:', error);
}
```

### iOS (Swift)

```swift
let voiceAuth = VoiceAuthManager(
    baseURL: "https://api.molam.com",
    token: jwtToken
)

// Enrollment
voiceAuth.enroll(locale: "fr_SN") { result in
    switch result {
    case .success:
        print("‚úÖ Voice enrolled!")
    case .failure(let error):
        print("‚ùå Error: \(error)")
    }
}

// Verification
voiceAuth.verify(locale: "fr_SN") { result in
    switch result {
    case .success(let (similarity, spoofing)):
        print("‚úÖ Verified! Similarity: \(similarity)")
    case .failure(let error):
        print("‚ùå Error: \(error)")
    }
}
```

### Android (Kotlin)

```kotlin
val voiceAuth = VoiceAuthManager(
    context,
    "https://api.molam.com",
    jwtToken
)

// Enrollment
lifecycleScope.launch {
    voiceAuth.enroll("fr_SN").fold(
        onSuccess = { println("‚úÖ Voice enrolled!") },
        onFailure = { println("‚ùå Error: ${it.message}") }
    )
}

// Verification
lifecycleScope.launch {
    voiceAuth.verify("fr_SN").fold(
        onSuccess = { (similarity, spoofing) ->
            println("‚úÖ Verified! Similarity: $similarity")
        },
        onFailure = { println("‚ùå Error: ${it.message}") }
    )
}
```

---

## üîí S√©curit√©

### Privacy-first Design

| Donn√©e | Stockage | Dur√©e | Chiffrement |
|--------|----------|-------|-------------|
| **Audio brut** | S3 √©ph√©m√®re | <24h | SSE-KMS |
| **Embedding** | PostgreSQL | Permanent | AES-256-GCM + envelope |
| **Salt** | PostgreSQL | Permanent | AES-256-GCM + envelope |
| **HMAC** | PostgreSQL | Permanent | Non (hash public) |

### Flux de s√©curit√©

1. **Audio capture**: Client (5-15 secondes)
2. **Upload**: HTTPS ‚Üí S3 temp (SSE-KMS)
3. **ML extraction**: Voice ML service (gRPC interne)
4. **Envelope encryption**:
   ```
   Embedding ‚Üí AES-256-GCM(embedding, DEK) ‚Üí [iv|tag|ct]
   Salt ‚Üí AES-256-GCM(salt, DEK) ‚Üí [iv|tag|ct]
   ```
5. **Storage**: PostgreSQL (encrypted blobs)
6. **Purge audio**: Delete from S3 immediately after

### Anti-spoofing

- **Score ML**: ASVspoof-like d√©tection
- **Seuil**: Configurable par user (d√©faut: 0.35)
- **SIRA**: Adaptation dynamique selon risque

### Compliance

- ‚úÖ **RGPD**: Minimisation donn√©es, consentement explicite, opt-out
- ‚úÖ **PCI-DSS**: Step-up pour transactions sensibles
- ‚úÖ **ISO 27001**: Audit immuable, chiffrement bout-en-bout

---

## üß™ Tests

```bash
# Unit tests
npm test

# E2E tests
npm run test:e2e

# Coverage
npm run test:coverage
```

### Test structure

```
tests/
‚îú‚îÄ‚îÄ voice.test.ts          # E2E tests (enrollment, verify, prefs)
‚îú‚îÄ‚îÄ ivr.test.ts            # IVR webhook tests
‚îî‚îÄ‚îÄ security.test.ts       # Security & crypto tests
```

---

## üöÄ D√©ploiement

### Kubernetes

```bash
# Apply secrets
kubectl create secret generic voice-auth-secrets \
  --from-literal=jwt-public-key="$(cat jwt-public.pem)" \
  --from-literal=data-enc-key="$(openssl rand -hex 32)" \
  --from-literal=database-url="postgresql://..." \
  --from-literal=redis-url="redis://..." \
  --from-literal=aws-access-key-id="..." \
  --from-literal=aws-secret-access-key="..." \
  --from-literal=kms-key-id="alias/molam-voice" \
  --from-literal=ivr-webhook-secret="..."

# Deploy
kubectl apply -f k8s/deployment.yaml

# Check status
kubectl get pods -l app=voice-auth
kubectl logs -f deployment/voice-auth
```

### Docker

```bash
# Build
docker build -t molam/voice-auth:1.0.0 .

# Run
docker run -d \
  --name voice-auth \
  -p 8081:8081 \
  --env-file .env \
  molam/voice-auth:1.0.0
```

### Production checklist

- [ ] PostgreSQL avec r√©plication (hot standby)
- [ ] Redis Sentinel (HA)
- [ ] S3 bucket avec lifecycle (<24h)
- [ ] KMS keys multi-region
- [ ] mTLS √† la gateway
- [ ] Rate limiting activ√©
- [ ] Monitoring & alertes configur√©s
- [ ] Backup automatique
- [ ] Rollback plan en place

---

## üìä Observabilit√©

### M√©triques Prometheus

```prometheus
# Enrollment
voice_enroll_total{locale,channel}
voice_enroll_fail_total{reason}
voice_enroll_duration_seconds

# Verification
voice_assert_total{success}
voice_assert_duration_seconds
voice_similarity_avg{locale}
voice_spoofing_avg{locale}

# Quality
voice_quality_score_avg
voice_audio_duration_seconds

# Errors
voice_ml_timeout_total
voice_s3_error_total
```

### Logs structur√©s

```json
{
  "timestamp": "2025-01-27T10:30:45.123Z",
  "level": "info",
  "event": "voice_assert_ok",
  "userId": "uuid",
  "reqId": "uuid",
  "similarity": 0.8542,
  "spoofing": 0.12,
  "locale": "fr_SN",
  "channel": "mobile_app",
  "ip": "197.149.x.x",
  "country": "SN"
}
```

### Alertes

- `voice_assert_fail_rate > 10%` (par pays)
- `voice_ml_timeout_total > 5/min`
- `voice_spoofing_avg > 0.40` (possible attaque)
- `voice_s3_error_total > 0`

---

## üìñ Documentation suppl√©mentaire

- [ARCHITECTURE.md](docs/ARCHITECTURE.md) - Design d√©taill√©
- [SECURITY.md](docs/SECURITY.md) - Threat model & mitigations
- [API.md](docs/API.md) - R√©f√©rence API compl√®te
- [INTEGRATION.md](docs/INTEGRATION.md) - Guides d'int√©gration
- [DEPLOYMENT.md](docs/DEPLOYMENT.md) - D√©ploiement production

---

## ü§ù Support

Pour questions ou probl√®mes:
- üìß Email: support@molam.com
- üí¨ Slack: #voice-auth
- üìù Issues: GitHub Issues

---

## üìÑ Licence

Propri√©taire - Molam ¬© 2025

---

**üéâ Brique 8 - Voice Auth est maintenant pr√™te pour production !**
